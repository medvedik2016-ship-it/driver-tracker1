<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <title>–ó–æ–Ω–∞ –ø–æ–≥—Ä—É–∑–∫–∏ - –£—á—ë—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π</title>
  <style>
    :root {
  /* Primitive Color Tokens */
  --color-white: rgba(255, 255, 255, 1);
  --color-black: rgba(0, 0, 0, 1);
  --color-cream-50: rgba(252, 252, 249, 1);
  --color-cream-100: rgba(255, 255, 253, 1);
  --color-gray-200: rgba(245, 245, 245, 1);
  --color-gray-300: rgba(167, 169, 169, 1);
  --color-gray-400: rgba(119, 124, 124, 1);
  --color-slate-500: rgba(98, 108, 113, 1);
  --color-brown-600: rgba(94, 82, 64, 1);
  --color-charcoal-700: rgba(31, 33, 33, 1);
  --color-charcoal-800: rgba(38, 40, 40, 1);
  --color-slate-900: rgba(19, 52, 59, 1);
  --color-teal-300: rgba(50, 184, 198, 1);
  --color-teal-400: rgba(45, 166, 178, 1);
  --color-teal-500: rgba(33, 128, 141, 1);
  --color-teal-600: rgba(29, 116, 128, 1);
  --color-teal-700: rgba(26, 104, 115, 1);
  --color-teal-800: rgba(41, 150, 161, 1);
  --color-red-400: rgba(255, 84, 89, 1);
  --color-red-500: rgba(192, 21, 47, 1);
  --color-orange-400: rgba(230, 129, 97, 1);
  --color-orange-500: rgba(168, 75, 47, 1);

  /* RGB versions for opacity control */
  --color-brown-600-rgb: 94, 82, 64;
  --color-teal-500-rgb: 33, 128, 141;
  --color-slate-900-rgb: 19, 52, 59;
  --color-slate-500-rgb: 98, 108, 113;
  --color-red-500-rgb: 192, 21, 47;
  --color-red-400-rgb: 255, 84, 89;
  --color-orange-500-rgb: 168, 75, 47;
  --color-orange-400-rgb: 230, 129, 97;

  /* Background color tokens (Light Mode) */
  --color-bg-1: rgba(59, 130, 246, 0.08);
  --color-bg-2: rgba(245, 158, 11, 0.08);
  --color-bg-3: rgba(34, 197, 94, 0.08);
  --color-bg-4: rgba(239, 68, 68, 0.08);
  --color-bg-5: rgba(147, 51, 234, 0.08);
  --color-bg-6: rgba(249, 115, 22, 0.08);
  --color-bg-7: rgba(236, 72, 153, 0.08);
  --color-bg-8: rgba(6, 182, 212, 0.08);

  /* Semantic Color Tokens (Light Mode) */
  --color-background: var(--color-cream-50);
  --color-surface: var(--color-cream-100);
  --color-text: var(--color-slate-900);
  --color-text-secondary: var(--color-slate-500);
  --color-primary: var(--color-teal-500);
  --color-primary-hover: var(--color-teal-600);
  --color-primary-active: var(--color-teal-700);
  --color-secondary: rgba(var(--color-brown-600-rgb), 0.12);
  --color-secondary-hover: rgba(var(--color-brown-600-rgb), 0.2);
  --color-secondary-active: rgba(var(--color-brown-600-rgb), 0.25);
  --color-border: rgba(var(--color-brown-600-rgb), 0.2);
  --color-btn-primary-text: var(--color-cream-50);
  --color-card-border: rgba(var(--color-brown-600-rgb), 0.12);
  --color-card-border-inner: rgba(var(--color-brown-600-rgb), 0.12);
  --color-error: var(--color-red-500);
  --color-success: var(--color-teal-500);
  --color-warning: var(--color-orange-500);
  --color-info: var(--color-slate-500);
  --color-focus-ring: rgba(var(--color-teal-500-rgb), 0.4);
  --color-select-caret: rgba(var(--color-slate-900-rgb), 0.8);

  /* Common style patterns */
  --focus-ring: 0 0 0 3px var(--color-focus-ring);
  --focus-outline: 2px solid var(--color-primary);
  --status-bg-opacity: 0.15;
  --status-border-opacity: 0.25;

  /* RGB versions for opacity control */
  --color-success-rgb: 33, 128, 141;
  --color-error-rgb: 192, 21, 47;
  --color-warning-rgb: 168, 75, 47;
  --color-info-rgb: 98, 108, 113;

  /* Typography */
  --font-family-base: "FKGroteskNeue", "Geist", "Inter", -apple-system,
    BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
  --font-family-mono: "Berkeley Mono", ui-monospace, SFMono-Regular, Menlo,
    Monaco, Consolas, monospace;
  --font-size-xs: 11px;
  --font-size-sm: 12px;
  --font-size-base: 14px;
  --font-size-md: 14px;
  --font-size-lg: 16px;
  --font-size-xl: 18px;
  --font-size-2xl: 20px;
  --font-size-3xl: 24px;
  --font-size-4xl: 30px;
  --font-weight-normal: 400;
  --font-weight-medium: 500;
  --font-weight-semibold: 550;
  --font-weight-bold: 600;
  --line-height-tight: 1.2;
  --line-height-normal: 1.5;
  --letter-spacing-tight: -0.01em;

  /* Spacing */
  --space-0: 0;
  --space-1: 1px;
  --space-2: 2px;
  --space-4: 4px;
  --space-6: 6px;
  --space-8: 8px;
  --space-10: 10px;
  --space-12: 12px;
  --space-16: 16px;
  --space-20: 20px;
  --space-24: 24px;
  --space-32: 32px;

  /* Border Radius */
  --radius-sm: 6px;
  --radius-base: 8px;
  --radius-md: 10px;
  --radius-lg: 12px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-xs: 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.02);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.04),
    0 2px 4px -1px rgba(0, 0, 0, 0.02);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.04),
    0 4px 6px -2px rgba(0, 0, 0, 0.02);
  --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.15),
    inset 0 -1px 0 rgba(0, 0, 0, 0.03);

  /* Animation */
  --duration-fast: 150ms;
  --duration-normal: 250ms;
  --ease-standard: cubic-bezier(0.16, 1, 0.3, 1);

  /* Layout */
  --container-sm: 640px;
  --container-md: 768px;
  --container-lg: 1024px;
  --container-xl: 1280px;
}

/* Dark mode colors */
@media (prefers-color-scheme: dark) {
  :root {
    --color-gray-400-rgb: 119, 124, 124;
    --color-teal-300-rgb: 50, 184, 198;
    --color-gray-300-rgb: 167, 169, 169;
    --color-gray-200-rgb: 245, 245, 245;

    --color-bg-1: rgba(29, 78, 216, 0.15);
    --color-bg-2: rgba(180, 83, 9, 0.15);
    --color-bg-3: rgba(21, 128, 61, 0.15);
    --color-bg-4: rgba(185, 28, 28, 0.15);
    --color-bg-5: rgba(107, 33, 168, 0.15);
    --color-bg-6: rgba(194, 65, 12, 0.15);
    --color-bg-7: rgba(190, 24, 93, 0.15);
    --color-bg-8: rgba(8, 145, 178, 0.15);

    --color-background: var(--color-charcoal-700);
    --color-surface: var(--color-charcoal-800);
    --color-text: var(--color-gray-200);
    --color-text-secondary: rgba(var(--color-gray-300-rgb), 0.7);
    --color-primary: var(--color-teal-300);
    --color-primary-hover: var(--color-teal-400);
    --color-primary-active: var(--color-teal-800);
    --color-secondary: rgba(var(--color-gray-400-rgb), 0.15);
    --color-secondary-hover: rgba(var(--color-gray-400-rgb), 0.25);
    --color-secondary-active: rgba(var(--color-gray-400-rgb), 0.3);
    --color-border: rgba(var(--color-gray-400-rgb), 0.3);
    --color-error: var(--color-red-400);
    --color-success: var(--color-teal-300);
    --color-warning: var(--color-orange-400);
    --color-info: var(--color-gray-300);
    --color-focus-ring: rgba(var(--color-teal-300-rgb), 0.4);
    --color-btn-primary-text: var(--color-slate-900);
    --color-card-border: rgba(var(--color-gray-400-rgb), 0.2);
    --color-card-border-inner: rgba(var(--color-gray-400-rgb), 0.15);
    --shadow-inset-sm: inset 0 1px 0 rgba(255, 255, 255, 0.1),
      inset 0 -1px 0 rgba(0, 0, 0, 0.15);
    --color-select-caret: rgba(var(--color-gray-200-rgb), 0.8);

    --color-success-rgb: var(--color-teal-300-rgb);
    --color-error-rgb: var(--color-red-400-rgb);
    --color-warning-rgb: var(--color-orange-400-rgb);
    --color-info-rgb: var(--color-gray-300-rgb);
  }
}

@font-face {
  font-family: 'FKGroteskNeue';
  src: url('https://r2cdn.perplexity.ai/fonts/FKGroteskNeue.woff2')
    format('woff2');
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  font-size: var(--font-size-base);
  font-family: var(--font-family-base);
  line-height: var(--line-height-normal);
  color: var(--color-text);
  background-color: var(--color-background);
  -webkit-font-smoothing: antialiased;
  -webkit-tap-highlight-color: transparent;
}

body {
  margin: 0;
  padding: 0;
  min-height: 100vh;
}

/* Custom styles for the app */
.app-header {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
  padding: var(--space-16) var(--space-16);
  position: sticky;
  top: 0;
  z-index: 100;
  box-shadow: var(--shadow-md);
}

.app-header h1 {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-semibold);
  margin: 0;
}

.app-header .current-time {
  font-size: var(--font-size-sm);
  opacity: 0.9;
  margin-top: var(--space-4);
}

.container {
  max-width: 100%;
  padding: 0 var(--space-16) var(--space-24) var(--space-16);
}

/* Registration Form */
.registration-section {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  padding: var(--space-20);
  margin: var(--space-16) 0;
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-sm);
}

.registration-section h2 {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  margin-bottom: var(--space-16);
  color: var(--color-text);
}

.form-group {
  margin-bottom: var(--space-16);
}

.form-label {
  display: block;
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  margin-bottom: var(--space-8);
  color: var(--color-text);
}

.form-control {
  width: 100%;
  padding: var(--space-12) var(--space-16);
  font-size: var(--font-size-lg);
  border: 1px solid var(--color-border);
  border-radius: var(--radius-base);
  background: var(--color-background);
  color: var(--color-text);
  transition: border-color var(--duration-fast) var(--ease-standard);
  min-height: 48px;
}

.form-control:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: var(--focus-ring);
}

.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: var(--space-16) var(--space-24);
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-medium);
  border: none;
  border-radius: var(--radius-base);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  min-height: 52px;
  width: 100%;
}

.btn-primary {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.btn-primary:hover {
  background: var(--color-primary-hover);
}

.btn-primary:active {
  background: var(--color-primary-active);
}

.btn-secondary {
  background: var(--color-secondary);
  color: var(--color-text);
  font-size: var(--font-size-base);
  padding: var(--space-10) var(--space-16);
  min-height: 44px;
}

.btn-secondary:hover {
  background: var(--color-secondary-hover);
}

.btn-secondary:active {
  background: var(--color-secondary-active);
}

/* Statistics */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: var(--space-12);
  margin: var(--space-16) 0;
}

.stat-card {
  background: var(--color-surface);
  padding: var(--space-16);
  border-radius: var(--radius-md);
  border: 1px solid var(--color-card-border);
  text-align: center;
}

.stat-value {
  font-size: var(--font-size-3xl);
  font-weight: var(--font-weight-bold);
  color: var(--color-primary);
  display: block;
}

.stat-label {
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-top: var(--space-4);
  display: block;
}

/* Section Headers */
.section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin: var(--space-24) 0 var(--space-16) 0;
}

.section-header h2 {
  font-size: var(--font-size-xl);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
}

.section-header .badge {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
  padding: var(--space-4) var(--space-12);
  border-radius: var(--radius-full);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
}

/* Driver Cards */
.driver-list {
  display: flex;
  flex-direction: column;
  gap: var(--space-12);
}

.driver-card {
  background: var(--color-surface);
  border: 1px solid var(--color-card-border);
  border-radius: var(--radius-lg);
  padding: var(--space-16);
  box-shadow: var(--shadow-sm);
  transition: box-shadow var(--duration-normal) var(--ease-standard);
}

.driver-card.warning {
  border-color: var(--color-warning);
  background: rgba(var(--color-warning-rgb), 0.05);
}

.driver-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: var(--space-12);
}

.driver-info h3 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-semibold);
  color: var(--color-text);
  margin-bottom: var(--space-4);
}

.vehicle-number {
  font-size: var(--font-size-base);
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
  font-family: var(--font-family-mono);
}

.driver-meta {
  display: flex;
  flex-direction: column;
  gap: var(--space-6);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-bottom: var(--space-12);
}

.meta-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.meta-label {
  font-weight: var(--font-weight-medium);
}

.meta-value {
  font-family: var(--font-family-mono);
}

.duration-badge {
  background: var(--color-bg-1);
  color: var(--color-primary);
  padding: var(--space-6) var(--space-12);
  border-radius: var(--radius-full);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  font-family: var(--font-family-mono);
}

.duration-badge.warning {
  background: rgba(var(--color-warning-rgb), 0.15);
  color: var(--color-warning);
}

.empty-state {
  text-align: center;
  padding: var(--space-32) var(--space-16);
  color: var(--color-text-secondary);
  font-size: var(--font-size-base);
}

.empty-state-icon {
  font-size: var(--font-size-4xl);
  margin-bottom: var(--space-16);
  opacity: 0.5;
}

/* Phone number display */
.phone-number {
  font-family: var(--font-family-mono);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);
  margin-top: var(--space-4);
}

/* Tab Navigation */
.tab-navigation {
  display: flex;
  background: var(--color-surface);
  border-bottom: 2px solid var(--color-card-border);
  position: sticky;
  top: 80px;
  z-index: 90;
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.tab-btn {
  flex: 1;
  min-width: 120px;
  padding: var(--space-16);
  background: transparent;
  border: none;
  color: var(--color-text-secondary);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
}

.tab-btn:hover {
  color: var(--color-text);
  background: var(--color-secondary);
}

.tab-btn.active {
  color: var(--color-primary);
  border-bottom-color: var(--color-primary);
}

.tab-content {
  display: none;
  padding-top: var(--space-16);
}

.tab-content.active {
  display: block;
}

/* Mode Toggle */
.mode-toggle {
  display: flex;
  gap: var(--space-8);
  margin-bottom: var(--space-20);
  background: var(--color-background);
  padding: var(--space-4);
  border-radius: var(--radius-base);
}

.mode-btn {
  flex: 1;
  padding: var(--space-12) var(--space-16);
  background: transparent;
  border: none;
  color: var(--color-text-secondary);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  border-radius: var(--radius-sm);
  transition: all var(--duration-normal) var(--ease-standard);
}

.mode-btn:hover {
  background: var(--color-secondary);
}

.mode-btn.active {
  background: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.driver-form {
  display: none;
}

.driver-form.active {
  display: block;
}

/* Checkbox Group */
.checkbox-group {
  margin-top: var(--space-12);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: var(--space-8);
  cursor: pointer;
  font-size: var(--font-size-base);
  color: var(--color-text);
}

.checkbox-label input[type="checkbox"] {
  width: 20px;
  height: 20px;
  cursor: pointer;
  accent-color: var(--color-primary);
}

/* Permanent Driver Badge */
.permanent-badge {
  display: inline-flex;
  align-items: center;
  gap: var(--space-4);
  background: rgba(var(--color-warning-rgb), 0.15);
  color: var(--color-warning);
  padding: var(--space-4) var(--space-8);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-medium);
}

.visit-count {
  background: var(--color-bg-1);
  color: var(--color-primary);
  padding: var(--space-4) var(--space-10);
  border-radius: var(--radius-full);
  font-size: var(--font-size-xs);
  font-weight: var(--font-weight-bold);
  margin-left: var(--space-8);
}

/* Action Buttons */
.action-buttons {
  display: flex;
  gap: var(--space-8);
  margin-top: var(--space-12);
}

.btn-small {
  padding: var(--space-8) var(--space-12);
  font-size: var(--font-size-sm);
  min-height: 36px;
}

.btn-outline {
  background: transparent;
  border: 1px solid var(--color-border);
  color: var(--color-text);
}

.btn-outline:hover {
  background: var(--color-secondary);
}

.btn-danger {
  background: rgba(var(--color-error-rgb), 0.1);
  color: var(--color-error);
  border: 1px solid rgba(var(--color-error-rgb), 0.3);
}

.btn-danger:hover {
  background: rgba(var(--color-error-rgb), 0.2);
}

/* Success Message */
.success-message {
  background: rgba(var(--color-success-rgb), 0.15);
  color: var(--color-success);
  padding: var(--space-12) var(--space-16);
  border-radius: var(--radius-base);
  margin-bottom: var(--space-16);
  border: 1px solid rgba(var(--color-success-rgb), 0.3);
  font-size: var(--font-size-base);
  font-weight: var(--font-weight-medium);
  display: none;
}

.success-message.show {
  display: block;
  animation: slideIn var(--duration-normal) var(--ease-standard);
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(-10px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive adjustments */
@media (min-width: 640px) {
  .container {
    max-width: var(--container-sm);
    margin: 0 auto;
  }
}

@media (min-width: 768px) {
  .driver-meta {
    flex-direction: row;
    justify-content: space-between;
  }
  
  .meta-row {
    flex-direction: column;
    align-items: flex-start;
  }
}

/* Login Screen Styles */
.login-screen {
  display: flex;
  justify-content: center;
  align-items: center;
  min-height: 100vh;
  background: var(--color-background);
  padding: var(--space-16);
}

.login-container {
  background: var(--color-surface);
  border-radius: var(--radius-lg);
  border: 1px solid var(--color-card-border);
  box-shadow: var(--shadow-lg);
  padding: var(--space-32);
  max-width: 500px;
  width: 100%;
}

.login-header h1 {
  font-size: var(--font-size-2xl);
  font-weight: var(--font-weight-semibold);
  text-align: center;
  margin-bottom: var(--space-32);
  color: var(--color-text);
}

.login-content h2 {
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-medium);
  text-align: center;
  margin-bottom: var(--space-20);
  color: var(--color-text-secondary);
}

.role-buttons {
  display: flex;
  flex-direction: column;
  gap: var(--space-12);
  margin-bottom: var(--space-24);
}

.role-btn {
  display: flex;
  align-items: center;
  gap: var(--space-16);
  padding: var(--space-20);
  background: var(--color-background);
  border: 2px solid var(--color-border);
  border-radius: var(--radius-base);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
  font-size: var(--font-size-lg);
  font-weight: var(--font-weight-medium);
  color: var(--color-text);
}

.role-btn:hover {
  background: var(--color-secondary);
  border-color: var(--color-primary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.role-btn.selected {
  background: var(--color-primary);
  border-color: var(--color-primary);
  color: var(--color-btn-primary-text);
}

.role-icon {
  font-size: var(--font-size-3xl);
}

.role-name {
  flex: 1;
}

.password-section {
  margin-top: var(--space-24);
}

.error-message {
  display: none;
  background: rgba(var(--color-error-rgb), 0.15);
  color: var(--color-error);
  padding: var(--space-12);
  border-radius: var(--radius-base);
  margin-top: var(--space-12);
  margin-bottom: var(--space-12);
  text-align: center;
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  border: 1px solid rgba(var(--color-error-rgb), 0.3);
}

/* Header with user info */
.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--space-16);
}

.user-info {
  display: flex;
  flex-direction: column;
  align-items: flex-end;
  gap: var(--space-8);
}

.logged-in-as {
  font-size: var(--font-size-sm);
  opacity: 0.9;
}

.btn-logout {
  padding: var(--space-8) var(--space-16);
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  border-radius: var(--radius-base);
  color: var(--color-btn-primary-text);
  font-size: var(--font-size-sm);
  font-weight: var(--font-weight-medium);
  cursor: pointer;
  transition: all var(--duration-normal) var(--ease-standard);
}

.btn-logout:hover {
  background: rgba(255, 255, 255, 0.3);
}

/* Location Selection Specific */
.location-btn-general {
  background: linear-gradient(135deg, #7c3aed 0%, #a855f7 100%);
  color: white;
  border-color: #7c3aed;
}

.location-btn-general:hover {
  background: linear-gradient(135deg, #6d28d9 0%, #9333ea 100%);
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(124, 58, 237, 0.3);
}

.location-btn-general.selected {
  background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
}

/* Role-based theme colors */
body.role-driver .app-header {
  background: #1e40af; /* Blue */
}

body.role-supervisor .app-header {
  background: #059669; /* Green */
}

body.role-manager .app-header {
  background: #7c3aed; /* Purple */
}

body.role-driver .role-btn.selected,
body.role-driver .btn-primary {
  background: #1e40af;
}

body.role-supervisor .role-btn.selected {
  background: #059669;
}

body.role-manager .role-btn.selected {
  background: #7c3aed;
}

/* Settings Info */
.settings-info {
  background: var(--color-background);
  padding: var(--space-16);
  border-radius: var(--radius-base);
  margin-top: var(--space-16);
}

.settings-info p {
  margin: var(--space-12) 0;
  font-size: var(--font-size-base);
  color: var(--color-text);
}

.settings-info strong {
  color: var(--color-text-secondary);
  font-weight: var(--font-weight-medium);
}

/* Read-only indicator for supervisor */
body.role-supervisor #registration-tab .section-header h2::after,
body.role-supervisor #permanent-tab .section-header h2::after,
body.role-supervisor #history-tab .section-header h2::after {
  content: ' (—Ç–æ–ª—å–∫–æ –ø—Ä–æ—Å–º–æ—Ç—Ä)';
  font-size: var(--font-size-sm);
  color: var(--color-info);
  font-weight: var(--font-weight-normal);
}

/* Responsive login */
@media (max-width: 640px) {
  .login-container {
    padding: var(--space-24);
  }
  
  .login-header h1 {
    font-size: var(--font-size-xl);
  }
  
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .user-info {
    align-items: flex-start;
    width: 100%;
  }
  
  .btn-logout {
    width: 100%;
  }
  
  body.role-supervisor .section-header {
    flex-direction: column;
    align-items: flex-start;
  }
}
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen" class="login-screen">
    <div class="login-container">
      <div class="login-header">
        <h1>üöõ –£—á—ë—Ç –ø—Ä–∏–µ–∑–¥–∞ –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–∞ –∑–æ–Ω—É –ø–æ–≥—Ä—É–∑–∫–∏</h1>
      </div>
      <div class="login-content">
        <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ä–æ–ª—å:</h2>
        <div class="role-buttons">
          <button class="role-btn" data-role="driver">
            <span class="role-icon">üë§</span>
            <span class="role-name">–í–æ–¥–∏—Ç–µ–ª—å</span>
          </button>
          <button class="role-btn" data-role="supervisor">
            <span class="role-icon">üëÅÔ∏è</span>
            <span class="role-name">–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å</span>
          </button>
          <button class="role-btn" data-role="manager">
            <span class="role-icon">‚öôÔ∏è</span>
            <span class="role-name">–£–ø—Ä–∞–≤–ª—è—é—â–∏–π</span>
          </button>
        </div>
        <div class="password-section" id="passwordSection" style="display: none;">
          <label class="form-label" for="passwordInput">–ü–∞—Ä–æ–ª—å</label>
          <input type="password" id="passwordInput" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å">
          <div class="error-message" id="errorMessage">–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å</div>
          <button class="btn btn-primary" id="loginBtn">–í–æ–π—Ç–∏</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Location Selection Screen (shown after login) -->
  <div id="locationScreen" style="display: none;">
    <div class="login-screen">
      <div class="login-container">
        <div class="login-header">
          <h1>üöõ –í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç</h1>
        </div>
        <div class="login-content">
          <h2>–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã:</h2>
          <div class="role-buttons" id="locationButtons">
            <button class="role-btn location-btn" data-location="vegas">
              <span class="role-icon">üì¶</span>
              <span class="role-name">–õ–ü –í–µ–≥–∞—Å</span>
            </button>
            <button class="role-btn location-btn" data-location="domodedovo">
              <span class="role-icon">üì¶</span>
              <span class="role-name">–õ–ü –î–æ–º–æ–¥–µ–¥–æ–≤–æ</span>
            </button>
            <button class="role-btn location-btn" data-location="klimovsk">
              <span class="role-icon">üì¶</span>
              <span class="role-name">–õ–ü –ö–ª–∏–º–æ–≤—Å–∫</span>
            </button>
            <button class="role-btn location-btn" data-location="kievskoe">
              <span class="role-icon">üì¶</span>
              <span class="role-name">–õ–ü –ö–∏–µ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ</span>
            </button>
            <button class="role-btn location-btn location-btn-general" data-location="general" id="generalLocationBtn" style="display: none;">
              <span class="role-icon">üåê</span>
              <span class="role-name">–û–±—â–µ–µ</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main App (hidden until location selected) -->
  <div id="mainApp" style="display: none;">
  <header class="app-header">
    <div class="header-content">
      <div>
        <h1>üöõ –ó–æ–Ω–∞ –ø–æ–≥—Ä—É–∑–∫–∏</h1>
        <div class="current-time" id="currentTime"></div>
      </div>
      <div class="user-info">
        <span class="logged-in-as">–í—ã –≤–æ—à–ª–∏ –∫–∞–∫: <strong id="userRoleDisplay"></strong> | –û–±—ä–µ–∫—Ç: <strong id="currentLocationDisplay"></strong></span>
        <button class="btn-logout" id="changeLocationBtn" style="margin-right: var(--space-8);">–°–º–µ–Ω–∏—Ç—å –æ–±—ä–µ–∫—Ç</button>
        <button class="btn-logout" id="logoutBtn">–í—ã—Ö–æ–¥</button>
      </div>
    </div>
  </header>

  <!-- Tab Navigation -->
  <nav class="tab-navigation">
    <button class="tab-btn active" data-tab="registration">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    <button class="tab-btn" data-tab="history" id="historyTab">–ò—Å—Ç–æ—Ä–∏—è</button>
    <button class="tab-btn" data-tab="permanent">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</button>
    <button class="tab-btn" data-tab="statistics">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</button>
    <button class="tab-btn" data-tab="settings" style="display:none;">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</button>
  </nav>

  <div class="container">
    <!-- Registration Tab -->
    <div class="tab-content active" id="registration-tab">
    <!-- Registration Form -->
    <section class="registration-section">
      <h2>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–∏–µ–∑–¥–∞</h2>
      
      <!-- Registration Mode Toggle -->
      <div class="mode-toggle">
        <button type="button" class="mode-btn active" data-mode="new">–ù–æ–≤—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</button>
        <button type="button" class="mode-btn" data-mode="permanent">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å</button>
      </div>

      <!-- New Driver Form -->
      <form id="registrationForm" class="driver-form active">
        <div class="form-group">
          <label class="form-label" for="driverName">–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è</label>
          <input type="text" id="driverName" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="vehicleNumber">–ù–æ–º–µ—Ä –º–∞—à–∏–Ω—ã</label>
          <input type="text" id="vehicleNumber" class="form-control" placeholder="–ê123–ë–í77" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="phoneNumber">–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="tel" id="phoneNumber" class="form-control" placeholder="+7 916 123-45-67">
        </div>
        <div class="form-group checkbox-group">
          <label class="checkbox-label">
            <input type="checkbox" id="saveAsPermanent">
            <span>–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ</span>
          </label>
        </div>
        <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–µ–∑–¥</button>
      </form>

      <!-- Permanent Driver Selection -->
      <form id="permanentDriverForm" class="driver-form">
        <div class="form-group">
          <label class="form-label" for="permanentDriverSelect">–í—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è</label>
          <select id="permanentDriverSelect" class="form-control" required>
            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è --</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–∏–µ–∑–¥</button>
      </form>
    </section>

    <!-- Active Drivers -->
    <div class="section-header">
      <h2>–í–æ–¥–∏—Ç–µ–ª–∏ –Ω–∞ –∑–æ–Ω–µ</h2>
      <span class="badge" id="activeBadge">0</span>
    </div>
    <div class="driver-list" id="activeDriversList">
      <div class="empty-state">
        <div class="empty-state-icon">üìã</div>
        <p>–ù–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–∞ –∑–æ–Ω–µ</p>
      </div>
    </div>
    </div>

    <!-- History Tab -->
    <div class="tab-content" id="history-tab">
    <!-- Completed Visits -->
    <div class="section-header">
      <h2>–ò—Å—Ç–æ—Ä–∏—è –æ—Ç—ä–µ–∑–¥–æ–≤</h2>
    </div>
    <div class="driver-list" id="completedDriversList">
      <div class="empty-state">
        <div class="empty-state-icon">‚úì</div>
        <p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
      </div>
    </div>
    </div>

    <!-- Permanent Drivers Tab -->
    <div class="tab-content" id="permanent-tab">
    <section class="registration-section">
      <h2>–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è</h2>
      <form id="addPermanentDriverForm">
        <div class="form-group">
          <label class="form-label" for="permDriverName">–ò–º—è –≤–æ–¥–∏—Ç–µ–ª—è</label>
          <input type="text" id="permDriverName" class="form-control" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="permVehicleNumber">–ù–æ–º–µ—Ä –º–∞—à–∏–Ω—ã</label>
          <input type="text" id="permVehicleNumber" class="form-control" placeholder="–ê123–ë–í77" required>
        </div>
        <div class="form-group">
          <label class="form-label" for="permPhoneNumber">–¢–µ–ª–µ—Ñ–æ–Ω (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
          <input type="tel" id="permPhoneNumber" class="form-control" placeholder="+7 916 123-45-67">
        </div>
        <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è</button>
      </form>
    </section>

    <div class="section-header">
      <h2>–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h2>
      <span class="badge" id="permanentBadge">0</span>
    </div>
    <div class="driver-list" id="permanentDriversList">
      <div class="empty-state">
        <div class="empty-state-icon">üë•</div>
        <p>–ù–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</p>
      </div>
    </div>
    </div>

    <!-- Statistics Tab -->
    <div class="tab-content" id="statistics-tab">
    <!-- Statistics -->
    <div class="stats-grid">
      <div class="stat-card">
        <span class="stat-value" id="driversAtZone">0</span>
        <span class="stat-label">–í–æ–¥–∏—Ç–µ–ª–µ–π –Ω–∞ –∑–æ–Ω–µ</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="arrivalsToday">0</span>
        <span class="stat-label">–ü—Ä–∏–µ–∑–¥–æ–≤ —Å–µ–≥–æ–¥–Ω—è</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="averageTime">‚Äî</span>
        <span class="stat-label">–°—Ä–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è</span>
      </div>
      <div class="stat-card">
        <span class="stat-value" id="permanentDriversCount">0</span>
        <span class="stat-label">–ü–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</span>
      </div>
    </div>

    <div class="section-header">
      <h2>–°–∞–º—ã–µ —á–∞—Å—Ç—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏</h2>
    </div>
    <div class="driver-list" id="frequentDriversList">
      <div class="empty-state">
        <div class="empty-state-icon">‚≠ê</div>
        <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
      </div>
    </div>

    <!-- Settings Tab (Manager Only) -->
    <div class="tab-content" id="settings-tab">
      <section class="registration-section">
        <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã</h2>
        <div class="settings-info">
          <p><strong>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</strong> –£–ø—Ä–∞–≤–ª—è—é—â–∏–π</p>
          <p><strong>–í—Ä–µ–º—è –≤—Ö–æ–¥–∞:</strong> <span id="loginTimeDisplay"></span></p>
          <p><strong>–í—Å–µ–≥–æ –∑–∞–ø–∏—Å–µ–π:</strong> <span id="totalRecordsCount"></span></p>
        </div>
        <div class="action-buttons" style="margin-top: var(--space-24);">
          <button class="btn btn-outline" onclick="exportData()">–≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
          <button class="btn btn-danger" onclick="clearDailyData()">–û—á–∏—Å—Ç–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è</button>
        </div>
      </section>
    </div>

  </div>
  </div>

  <script>
    // Data storage
    let drivers = [];
    let permanentDrivers = [];
    let nextId = 1;
    let nextPermanentId = 101;
    let updateInterval = null;
    let currentTab = 'registration';
    let currentMode = 'new';
    
    // Location management
    let currentLocation = null;
    let isGeneralView = false;
    
    const LOCATIONS = {
      vegas: { id: 'vegas', name: '–õ–ü –í–µ–≥–∞—Å', code: 'VGS' },
      domodedovo: { id: 'domodedovo', name: '–õ–ü –î–æ–º–æ–¥–µ–¥–æ–≤–æ', code: 'DMD' },
      klimovsk: { id: 'klimovsk', name: '–õ–ü –ö–ª–∏–º–æ–≤—Å–∫', code: 'KLM' },
      kievskoe: { id: 'kievskoe', name: '–õ–ü –ö–∏–µ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ', code: 'KSH' },
      general: { id: 'general', name: '–û–±—â–µ–µ', code: 'ALL', managerOnly: true }
    };
    
    // Authentication
    let currentUserRole = null;
    let userLoginTime = null;
    let selectedRole = null;
    
    const PASSWORDS = {
      driver: 'driver123',
      supervisor: 'supervisor123',
      manager: 'manager123'
    };
    
    const ROLE_NAMES = {
      driver: '–í–æ–¥–∏—Ç–µ–ª—å',
      supervisor: '–†—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å',
      manager: '–£–ø—Ä–∞–≤–ª—è—é—â–∏–π'
    };
    
    const PERMISSIONS = {
      driver: {
        canRegisterArrival: true,
        canMarkDeparture: true,
        canViewOwnHistory: true,
        canViewAllStatistics: false,
        canViewAllDrivers: false,
        canManagePermanentDrivers: false,
        canEditData: false,
        canAccessSettings: false
      },
      supervisor: {
        canRegisterArrival: false,
        canMarkDeparture: false,
        canViewOwnHistory: false,
        canViewAllStatistics: true,
        canViewAllDrivers: true,
        canManagePermanentDrivers: false,
        canEditData: false,
        canAccessSettings: false
      },
      manager: {
        canRegisterArrival: true,
        canMarkDeparture: true,
        canViewOwnHistory: true,
        canViewAllStatistics: true,
        canViewAllDrivers: true,
        canManagePermanentDrivers: true,
        canEditData: true,
        canAccessSettings: true
      }
    };

    // Initialize permanent drivers with sample data
    function initializePermanentDrivers() {
      permanentDrivers = [
        {
          id: nextPermanentId++,
          driverName: '–ò–≤–∞–Ω–æ–≤ –ü–µ—Ç—Ä',
          vehicleNumber: '–ê123–ë–í77',
          phoneNumber: '+79161234567',
          totalVisits: 15,
          addedDate: '2025-10-01T09:00:00',
          lastVisit: null
        },
        {
          id: nextPermanentId++,
          driverName: '–°–∏–¥–æ—Ä–æ–≤ –ê–ª–µ–∫—Å–µ–π',
          vehicleNumber: '–í456–ì–î99',
          phoneNumber: '+79167654321',
          totalVisits: 23,
          addedDate: '2025-10-05T10:30:00',
          lastVisit: null
        },
        {
          id: nextPermanentId++,
          driverName: '–ö—É–∑–Ω–µ—Ü–æ–≤ –í–ª–∞–¥–∏–º–∏—Ä',
          vehicleNumber: '–°789–ö–õ50',
          phoneNumber: '+79169876543',
          totalVisits: 8,
          addedDate: '2025-10-15T14:20:00',
          lastVisit: null
        },
        {
          id: nextPermanentId++,
          driverName: '–°–º–∏—Ä–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π',
          vehicleNumber: '–ï012–ú–ù77',
          phoneNumber: '+79162223344',
          totalVisits: 31,
          addedDate: '2025-09-20T08:15:00',
          lastVisit: null
        }
      ];
    }

    // Initialize with sample data for demonstration
    function initializeSampleData() {
      const now = new Date();
      
      // Add sample active drivers with locations
      drivers.push({
        id: nextId++,
        permanentDriverId: 101,
        driverName: '–ò–≤–∞–Ω–æ–≤ –ü–µ—Ç—Ä',
        vehicleNumber: '–ê123–ë–í77',
        phoneNumber: '+79161234567',
        arrivalTime: new Date(now.getTime() - 90 * 60000).toISOString(), // 1.5 hours ago
        departureTime: null,
        status: 'active',
        isPermanent: true,
        locationId: 'vegas',
        locationName: '–õ–ü –í–µ–≥–∞—Å'
      });

      drivers.push({
        id: nextId++,
        permanentDriverId: null,
        driverName: '–ù–æ–≤–∏–∫–æ–≤ –ò–≥–æ—Ä—å',
        vehicleNumber: '–¢555–£–§99',
        phoneNumber: '',
        arrivalTime: new Date(now.getTime() - 45 * 60000).toISOString(), // 45 minutes ago
        departureTime: null,
        status: 'active',
        isPermanent: false,
        locationId: 'domodedovo',
        locationName: '–õ–ü –î–æ–º–æ–¥–µ–¥–æ–≤–æ'
      });

      // Add sample completed visit
      drivers.push({
        id: nextId++,
        permanentDriverId: null,
        driverName: '–ü–µ—Ç—Ä–æ–≤ –ú–∏—Ö–∞–∏–ª',
        vehicleNumber: '–°789–ï–ñ50',
        phoneNumber: '',
        arrivalTime: new Date(now.getTime() - 4 * 60 * 60000).toISOString(), // 4 hours ago
        departureTime: new Date(now.getTime() - 1.5 * 60 * 60000).toISOString(), // 1.5 hours ago
        status: 'completed',
        isPermanent: false,
        locationId: 'klimovsk',
        locationName: '–õ–ü –ö–ª–∏–º–æ–≤—Å–∫'
      });
      
      // Add more sample data for other locations
      drivers.push({
        id: nextId++,
        permanentDriverId: null,
        driverName: '–°–º–∏—Ä–Ω–æ–≤ –î–º–∏—Ç—Ä–∏–π',
        vehicleNumber: '–¢555–£–§99',
        phoneNumber: '',
        arrivalTime: new Date(now.getTime() - 60 * 60000).toISOString(),
        departureTime: null,
        status: 'active',
        isPermanent: false,
        locationId: 'kievskoe',
        locationName: '–õ–ü –ö–∏–µ–≤—Å–∫–æ–µ —à–æ—Å—Å–µ'
      });
    }

    // Format time
    function formatTime(dateString) {
      const date = new Date(dateString);
      return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
    }

    // Format duration
    function formatDuration(minutes) {
      const hours = Math.floor(minutes / 60);
      const mins = Math.floor(minutes % 60);
      
      if (hours > 0) {
        return `${hours}—á ${mins}–º`;
      }
      return `${mins}–º`;
    }

    // Calculate duration in minutes
    function calculateDuration(startTime, endTime = null) {
      const start = new Date(startTime);
      const end = endTime ? new Date(endTime) : new Date();
      return Math.floor((end - start) / 60000);
    }

    // Update current time display
    function updateCurrentTime() {
      const now = new Date();
      const timeString = now.toLocaleString('ru-RU', {
        weekday: 'long',
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
      document.getElementById('currentTime').textContent = timeString;
    }

    // Get filtered drivers by location
    function getFilteredDrivers() {
      if (isGeneralView) {
        return drivers;
      }
      return drivers.filter(d => d.locationId === currentLocation);
    }
    
    // Update statistics
    function updateStatistics() {
      const filteredDrivers = getFilteredDrivers();
      const activeDrivers = filteredDrivers.filter(d => d.status === 'active');
      const completedToday = filteredDrivers.filter(d => {
        if (d.status !== 'completed') return false;
        const departureDate = new Date(d.departureTime);
        const today = new Date();
        return departureDate.toDateString() === today.toDateString();
      });

      const totalArrivalsToday = activeDrivers.length + completedToday.length;

      // Calculate average time for completed visits
      let averageMinutes = 0;
      if (completedToday.length > 0) {
        const totalMinutes = completedToday.reduce((sum, driver) => {
          return sum + calculateDuration(driver.arrivalTime, driver.departureTime);
        }, 0);
        averageMinutes = Math.floor(totalMinutes / completedToday.length);
      }

      document.getElementById('driversAtZone').textContent = activeDrivers.length;
      document.getElementById('arrivalsToday').textContent = totalArrivalsToday;
      document.getElementById('averageTime').textContent = completedToday.length > 0 ? formatDuration(averageMinutes) : '‚Äî';
      document.getElementById('activeBadge').textContent = activeDrivers.length;
      document.getElementById('permanentDriversCount').textContent = permanentDrivers.length;
      document.getElementById('permanentBadge').textContent = permanentDrivers.length;
    }

    // Render active drivers
    function renderActiveDrivers() {
      const container = document.getElementById('activeDriversList');
      const filteredDrivers = getFilteredDrivers();
      const activeDrivers = filteredDrivers.filter(d => d.status === 'active').sort((a, b) => {
        return new Date(b.arrivalTime) - new Date(a.arrivalTime);
      });

      if (activeDrivers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>–ù–µ—Ç –≤–æ–¥–∏—Ç–µ–ª–µ–π –Ω–∞ –∑–æ–Ω–µ</p>
          </div>
        `;
        return;
      }

      container.innerHTML = activeDrivers.map(driver => {
        const duration = calculateDuration(driver.arrivalTime);
        const isLongWait = duration > 120; // More than 2 hours
        const locationBadge = isGeneralView ? `<span class="permanent-badge" style="background: var(--color-bg-5);">${driver.locationName}</span>` : '';
        
        return `
          <div class="driver-card ${isLongWait ? 'warning' : ''}">
            <div class="driver-card-header">
              <div class="driver-info">
                <h3>
                  ${driver.driverName}
                  ${driver.isPermanent ? '<span class="permanent-badge">‚≠ê –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π</span>' : ''}
                  ${locationBadge}
                </h3>
                <div class="vehicle-number">${driver.vehicleNumber}</div>
                ${driver.phoneNumber ? `<div class="phone-number">${driver.phoneNumber}</div>` : ''}
              </div>
              <span class="duration-badge ${isLongWait ? 'warning' : ''}" id="duration-${driver.id}">
                ${formatDuration(duration)}
              </span>
            </div>
            <div class="driver-meta">
              <div class="meta-row">
                <span class="meta-label">–ü—Ä–∏–µ—Ö–∞–ª:</span>
                <span class="meta-value">${formatTime(driver.arrivalTime)}</span>
              </div>
            </div>
            <button class="btn btn-secondary" onclick="markDeparture(${driver.id})">
              –û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç—ä–µ–∑–¥
            </button>
          </div>
        `;
      }).join('');
    }

    // Render completed drivers
    function renderCompletedDrivers() {
      const container = document.getElementById('completedDriversList');
      const filteredDrivers = getFilteredDrivers();
      const completedDrivers = filteredDrivers.filter(d => d.status === 'completed').sort((a, b) => {
        return new Date(b.departureTime) - new Date(a.departureTime);
      }).slice(0, 30);

      if (completedDrivers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚úì</div>
            <p>–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞</p>
          </div>
        `;
        return;
      }

      container.innerHTML = completedDrivers.map(driver => {
        const duration = calculateDuration(driver.arrivalTime, driver.departureTime);
        const locationBadge = isGeneralView ? `<span class="permanent-badge" style="background: var(--color-bg-5);">${driver.locationName}</span>` : '';
        
        return `
          <div class="driver-card">
            <div class="driver-card-header">
              <div class="driver-info">
                <h3>${driver.driverName} ${locationBadge}</h3>
                <div class="vehicle-number">${driver.vehicleNumber}</div>
                ${driver.phoneNumber ? `<div class="phone-number">${driver.phoneNumber}</div>` : ''}
              </div>
              <span class="duration-badge">
                ${formatDuration(duration)}
              </span>
            </div>
            <div class="driver-meta">
              <div class="meta-row">
                <span class="meta-label">–ü—Ä–∏–µ–∑–¥:</span>
                <span class="meta-value">${formatTime(driver.arrivalTime)}</span>
              </div>
              <div class="meta-row">
                <span class="meta-label">–û—Ç—ä–µ–∑–¥:</span>
                <span class="meta-value">${formatTime(driver.departureTime)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render all
    function renderAll() {
      renderActiveDrivers();
      renderCompletedDrivers();
      updateStatistics();
    }

    // Update durations for active drivers
    function updateDurations() {
      const activeDrivers = drivers.filter(d => d.status === 'active');
      activeDrivers.forEach(driver => {
        const durationElement = document.getElementById(`duration-${driver.id}`);
        if (durationElement) {
          const duration = calculateDuration(driver.arrivalTime);
          durationElement.textContent = formatDuration(duration);
          
          // Update warning class
          const card = durationElement.closest('.driver-card');
          if (duration > 120) {
            card.classList.add('warning');
            durationElement.classList.add('warning');
          } else {
            card.classList.remove('warning');
            durationElement.classList.remove('warning');
          }
        }
      });
    }

    // Register arrival (new driver)
    function registerArrival(event) {
      event.preventDefault();
      
      const driverName = document.getElementById('driverName').value.trim();
      const vehicleNumber = document.getElementById('vehicleNumber').value.trim();
      const phoneNumber = document.getElementById('phoneNumber').value.trim();
      const saveAsPermanent = document.getElementById('saveAsPermanent').checked;

      if (!driverName || !vehicleNumber) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è –∏ –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã');
        return;
      }

      let permanentDriverId = null;
      let isPermanent = false;

      // Check if driver should be saved as permanent
      if (saveAsPermanent) {
        // Check if vehicle number already exists
        const existingPermanent = permanentDrivers.find(pd => 
          pd.vehicleNumber.toLowerCase() === vehicleNumber.toLowerCase()
        );
        
        if (existingPermanent) {
          alert('–í–æ–¥–∏—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö');
        } else {
          // Add to permanent drivers
          const newPermanentDriver = {
            id: nextPermanentId++,
            driverName,
            vehicleNumber,
            phoneNumber,
            totalVisits: 0,
            addedDate: new Date().toISOString(),
            lastVisit: null
          };
          permanentDrivers.push(newPermanentDriver);
          permanentDriverId = newPermanentDriver.id;
          isPermanent = true;
          updatePermanentDriverSelect();
          showSuccessMessage('–í–æ–¥–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω –≤ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ');
        }
      }

      const newDriver = {
        id: nextId++,
        permanentDriverId,
        driverName,
        vehicleNumber,
        phoneNumber,
        arrivalTime: new Date().toISOString(),
        departureTime: null,
        status: 'active',
        isPermanent,
        locationId: currentLocation,
        locationName: LOCATIONS[currentLocation].name
      };

      drivers.push(newDriver);
      
      // Update visit count if permanent
      if (permanentDriverId) {
        const permDriver = permanentDrivers.find(pd => pd.id === permanentDriverId);
        if (permDriver) {
          permDriver.totalVisits++;
          permDriver.lastVisit = newDriver.arrivalTime;
        }
      }
      
      renderAll();

      // Clear form
      document.getElementById('registrationForm').reset();
      document.getElementById('driverName').focus();
    }

    // Register arrival (permanent driver)
    function registerPermanentDriverArrival(event) {
      event.preventDefault();
      
      const selectedId = parseInt(document.getElementById('permanentDriverSelect').value);
      if (!selectedId) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ –≤–æ–¥–∏—Ç–µ–ª—è');
        return;
      }

      const permanentDriver = permanentDrivers.find(pd => pd.id === selectedId);
      if (!permanentDriver) return;

      const newDriver = {
        id: nextId++,
        permanentDriverId: permanentDriver.id,
        driverName: permanentDriver.driverName,
        vehicleNumber: permanentDriver.vehicleNumber,
        phoneNumber: permanentDriver.phoneNumber,
        arrivalTime: new Date().toISOString(),
        departureTime: null,
        status: 'active',
        isPermanent: true,
        locationId: currentLocation,
        locationName: LOCATIONS[currentLocation].name
      };

      drivers.push(newDriver);
      
      // Update visit count
      permanentDriver.totalVisits++;
      permanentDriver.lastVisit = newDriver.arrivalTime;
      
      renderAll();

      // Reset form
      document.getElementById('permanentDriverForm').reset();
    }

    // Quick registration from permanent drivers list
    function quickRegisterPermanent(permanentDriverId) {
      const permanentDriver = permanentDrivers.find(pd => pd.id === permanentDriverId);
      if (!permanentDriver) return;

      const newDriver = {
        id: nextId++,
        permanentDriverId: permanentDriver.id,
        driverName: permanentDriver.driverName,
        vehicleNumber: permanentDriver.vehicleNumber,
        phoneNumber: permanentDriver.phoneNumber,
        arrivalTime: new Date().toISOString(),
        departureTime: null,
        status: 'active',
        isPermanent: true,
        locationId: currentLocation,
        locationName: LOCATIONS[currentLocation].name
      };

      drivers.push(newDriver);
      
      // Update visit count
      permanentDriver.totalVisits++;
      permanentDriver.lastVisit = newDriver.arrivalTime;
      
      renderAll();
      
      // Switch to registration tab to show the driver
      switchTab('registration');
      showSuccessMessage(`${permanentDriver.driverName} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω`);
    }

    // Add permanent driver
    function addPermanentDriver(event) {
      event.preventDefault();
      
      const driverName = document.getElementById('permDriverName').value.trim();
      const vehicleNumber = document.getElementById('permVehicleNumber').value.trim();
      const phoneNumber = document.getElementById('permPhoneNumber').value.trim();

      if (!driverName || !vehicleNumber) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è –∏ –Ω–æ–º–µ—Ä –º–∞—à–∏–Ω—ã');
        return;
      }

      // Check for duplicate vehicle number
      const existingPermanent = permanentDrivers.find(pd => 
        pd.vehicleNumber.toLowerCase() === vehicleNumber.toLowerCase()
      );
      
      if (existingPermanent) {
        alert('–í–æ–¥–∏—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º –Ω–æ–º–µ—Ä–æ–º –º–∞—à–∏–Ω—ã —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        return;
      }

      const newPermanentDriver = {
        id: nextPermanentId++,
        driverName,
        vehicleNumber,
        phoneNumber,
        totalVisits: 0,
        addedDate: new Date().toISOString(),
        lastVisit: null
      };

      permanentDrivers.push(newPermanentDriver);
      updatePermanentDriverSelect();
      renderPermanentDrivers();
      updateStatistics();
      
      // Clear form
      document.getElementById('addPermanentDriverForm').reset();
      document.getElementById('permDriverName').focus();
      
      showSuccessMessage('–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π –≤–æ–¥–∏—Ç–µ–ª—å –¥–æ–±–∞–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    }

    // Delete permanent driver
    function deletePermanentDriver(permanentDriverId) {
      const driver = permanentDrivers.find(pd => pd.id === permanentDriverId);
      if (!driver) return;

      if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${driver.driverName} (${driver.vehicleNumber})?`)) {
        permanentDrivers = permanentDrivers.filter(pd => pd.id !== permanentDriverId);
        updatePermanentDriverSelect();
        renderPermanentDrivers();
        updateStatistics();
        showSuccessMessage('–í–æ–¥–∏—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω –∏–∑ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö');
      }
    }

    // Edit permanent driver (simple implementation)
    function editPermanentDriver(permanentDriverId) {
      const driver = permanentDrivers.find(pd => pd.id === permanentDriverId);
      if (!driver) return;

      const newName = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è –≤–æ–¥–∏—Ç–µ–ª—è:', driver.driverName);
      if (newName && newName.trim()) {
        driver.driverName = newName.trim();
      }

      const newPhone = prompt('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–ª–µ—Ñ–æ–Ω:', driver.phoneNumber);
      if (newPhone !== null) {
        driver.phoneNumber = newPhone.trim();
      }

      updatePermanentDriverSelect();
      renderPermanentDrivers();
      showSuccessMessage('–î–∞–Ω–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã');
    }

    // Mark departure
    function markDeparture(driverId) {
      const driver = drivers.find(d => d.id === driverId);
      if (!driver) return;

      const duration = calculateDuration(driver.arrivalTime);
      const confirmMessage = `–û—Ç–º–µ—Ç–∏—Ç—å –æ—Ç—ä–µ–∑–¥ –≤–æ–¥–∏—Ç–µ–ª—è ${driver.driverName} (${driver.vehicleNumber})?\n–í—Ä–µ–º—è –Ω–∞ –∑–æ–Ω–µ: ${formatDuration(duration)}`;
      
      if (confirm(confirmMessage)) {
        driver.departureTime = new Date().toISOString();
        driver.status = 'completed';
        renderAll();
      }
    }

    // Render permanent drivers list
    function renderPermanentDrivers() {
      const container = document.getElementById('permanentDriversList');
      
      if (permanentDrivers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üë•</div>
            <p>–ù–µ—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö –≤–æ–¥–∏—Ç–µ–ª–µ–π</p>
          </div>
        `;
        return;
      }

      // Sort by total visits (descending)
      const sortedDrivers = [...permanentDrivers].sort((a, b) => b.totalVisits - a.totalVisits);

      container.innerHTML = sortedDrivers.map(driver => {
        const lastVisitText = driver.lastVisit ? formatTime(driver.lastVisit) : '–ù–µ –±—ã–ª–æ';
        
        return `
          <div class="driver-card">
            <div class="driver-card-header">
              <div class="driver-info">
                <h3>
                  ${driver.driverName}
                  <span class="visit-count">${driver.totalVisits} ${driver.totalVisits === 1 ? '–≤–∏–∑–∏—Ç' : driver.totalVisits < 5 ? '–≤–∏–∑–∏—Ç–∞' : '–≤–∏–∑–∏—Ç–æ–≤'}</span>
                </h3>
                <div class="vehicle-number">${driver.vehicleNumber}</div>
                ${driver.phoneNumber ? `<div class="phone-number">${driver.phoneNumber}</div>` : ''}
              </div>
            </div>
            <div class="driver-meta">
              <div class="meta-row">
                <span class="meta-label">–ü–æ—Å–ª–µ–¥–Ω–∏–π –≤–∏–∑–∏—Ç:</span>
                <span class="meta-value">${lastVisitText}</span>
              </div>
            </div>
            <div class="action-buttons">
              <button class="btn btn-primary btn-small" onclick="quickRegisterPermanent(${driver.id})">
                –ë—ã—Å—Ç—Ä–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
              </button>
              <button class="btn btn-outline btn-small" onclick="editPermanentDriver(${driver.id})">
                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
              </button>
              <button class="btn btn-danger btn-small" onclick="deletePermanentDriver(${driver.id})">
                –£–¥–∞–ª–∏—Ç—å
              </button>
            </div>
          </div>
        `;
      }).join('');
    }

    // Render frequent drivers in statistics
    function renderFrequentDrivers() {
      const container = document.getElementById('frequentDriversList');
      
      // Get top 5 permanent drivers by visit count
      const topDrivers = [...permanentDrivers]
        .sort((a, b) => b.totalVisits - a.totalVisits)
        .slice(0, 5)
        .filter(d => d.totalVisits > 0);

      if (topDrivers.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚≠ê</div>
            <p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</p>
          </div>
        `;
        return;
      }

      container.innerHTML = topDrivers.map((driver, index) => {
        return `
          <div class="driver-card">
            <div class="driver-card-header">
              <div class="driver-info">
                <h3>
                  ${index === 0 ? 'ü•á' : index === 1 ? 'ü•à' : index === 2 ? 'ü•â' : '‚≠ê'} ${driver.driverName}
                  <span class="visit-count">${driver.totalVisits} ${driver.totalVisits === 1 ? '–≤–∏–∑–∏—Ç' : driver.totalVisits < 5 ? '–≤–∏–∑–∏—Ç–∞' : '–≤–∏–∑–∏—Ç–æ–≤'}</span>
                </h3>
                <div class="vehicle-number">${driver.vehicleNumber}</div>
              </div>
            </div>
          </div>
        `;
      }).join('');
    }

    // Update permanent driver select dropdown
    function updatePermanentDriverSelect() {
      const select = document.getElementById('permanentDriverSelect');
      const sortedDrivers = [...permanentDrivers].sort((a, b) => 
        a.driverName.localeCompare(b.driverName, 'ru')
      );

      select.innerHTML = '<option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–≥–æ –≤–æ–¥–∏—Ç–µ–ª—è --</option>' +
        sortedDrivers.map(driver => 
          `<option value="${driver.id}">${driver.driverName} - ${driver.vehicleNumber}</option>`
        ).join('');
    }

    // Show success message
    function showSuccessMessage(message) {
      // Create message element if it doesn't exist
      let messageEl = document.getElementById('successMessage');
      if (!messageEl) {
        messageEl = document.createElement('div');
        messageEl.id = 'successMessage';
        messageEl.className = 'success-message';
        const registrationSection = document.querySelector('.registration-section');
        registrationSection.insertBefore(messageEl, registrationSection.firstChild);
      }

      messageEl.textContent = message;
      messageEl.classList.add('show');

      setTimeout(() => {
        messageEl.classList.remove('show');
      }, 3000);
    }

    // Tab switching
    function switchTab(tabName) {
      currentTab = tabName;
      
      // Update tab buttons
      document.querySelectorAll('.tab-btn').forEach(btn => {
        if (btn.dataset.tab === tabName) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        if (content.id === `${tabName}-tab`) {
          content.classList.add('active');
        } else {
          content.classList.remove('active');
        }
      });

      // Render appropriate content
      if (tabName === 'permanent') {
        renderPermanentDrivers();
      } else if (tabName === 'statistics') {
        renderFrequentDrivers();
      }
    }

    // Mode switching
    function switchMode(mode) {
      currentMode = mode;
      
      // Update mode buttons
      document.querySelectorAll('.mode-btn').forEach(btn => {
        if (btn.dataset.mode === mode) {
          btn.classList.add('active');
        } else {
          btn.classList.remove('active');
        }
      });

      // Update forms
      document.querySelectorAll('.driver-form').forEach(form => {
        form.classList.remove('active');
      });

      if (mode === 'new') {
        document.getElementById('registrationForm').classList.add('active');
      } else {
        document.getElementById('permanentDriverForm').classList.add('active');
      }
    }

    // Authentication functions
    function handleRoleSelection(role) {
      selectedRole = role;
      document.querySelectorAll('.role-btn').forEach(btn => {
        btn.classList.toggle('selected', btn.dataset.role === role);
      });
      document.getElementById('passwordSection').style.display = 'block';
      document.getElementById('passwordInput').focus();
    }
    
    function handleLogin() {
      const password = document.getElementById('passwordInput').value;
      const errorMessage = document.getElementById('errorMessage');
      
      if (password === PASSWORDS[selectedRole]) {
        currentUserRole = selectedRole;
        userLoginTime = new Date().toISOString();
        errorMessage.style.display = 'none';
        showMainApp();
      } else {
        errorMessage.style.display = 'block';
        document.getElementById('passwordInput').value = '';
        document.getElementById('passwordInput').focus();
      }
    }
    
    // Location selection functions
    function handleLocationSelection(locationId) {
      currentLocation = locationId;
      isGeneralView = (locationId === 'general');
      
      document.getElementById('locationScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'block';
      
      // Update location display
      const locationName = isGeneralView ? '–û–±—â–µ–µ (–≤—Å–µ –æ–±—ä–µ–∫—Ç—ã)' : LOCATIONS[locationId].name;
      document.getElementById('currentLocationDisplay').textContent = locationName;
      
      // Re-render all data with location filter
      renderAll();
    }
    
    function showLocationSelection() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('mainApp').style.display = 'none';
      document.getElementById('locationScreen').style.display = 'flex';
      
      // Show/hide "–û–±—â–µ–µ" button based on role
      const generalBtn = document.getElementById('generalLocationBtn');
      if (currentUserRole === 'manager') {
        generalBtn.style.display = 'flex';
      } else {
        generalBtn.style.display = 'none';
      }
    }
    
    function handleChangeLocation() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —Å–º–µ–Ω–∏—Ç—å –æ–±—ä–µ–∫—Ç?')) {
        document.getElementById('mainApp').style.display = 'none';
        showLocationSelection();
      }
    }
    
    function showMainApp() {
      document.getElementById('loginScreen').style.display = 'none';
      showLocationSelection();
      document.getElementById('userRoleDisplay').textContent = ROLE_NAMES[currentUserRole];
      
      // Apply role-based theme
      document.body.className = `role-${currentUserRole}`;
      
      // Initialize the app first
      initApp();
      
      // Configure interface based on role
      configureInterfaceForRole();
      
      // Set default tab based on role
      if (currentUserRole === 'driver') {
        switchTab('registration');
      } else if (currentUserRole === 'supervisor') {
        switchTab('statistics');
      } else {
        switchTab('registration');
      }
      
      // Apply role restrictions after rendering
      setTimeout(() => {
        applyRoleRestrictions();
      }, 100);
    }
    
    function handleLogout() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
        currentUserRole = null;
        userLoginTime = null;
        selectedRole = null;
        document.getElementById('loginScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
        document.getElementById('passwordSection').style.display = 'none';
        document.getElementById('passwordInput').value = '';
        document.getElementById('errorMessage').style.display = 'none';
        document.querySelectorAll('.role-btn').forEach(btn => {
          btn.classList.remove('selected');
        });
        document.body.className = '';
        
        // Don't clear intervals as we want them to persist
      }
    }
    
    function configureInterfaceForRole() {
      const tabs = document.querySelectorAll('.tab-btn');
      
      tabs.forEach(tab => {
        const tabName = tab.dataset.tab;
        
        if (currentUserRole === 'driver') {
          // Driver can only see registration and their own history
          if (tabName === 'registration') {
            tab.style.display = 'flex';
            tab.textContent = '–ú–æ—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
          } else if (tabName === 'history') {
            tab.style.display = 'flex';
            tab.textContent = '–ú–æ—è –∏—Å—Ç–æ—Ä–∏—è';
          } else {
            tab.style.display = 'none';
          }
        } else if (currentUserRole === 'supervisor') {
          // Supervisor can see statistics, active drivers, and history
          if (tabName === 'statistics') {
            tab.style.display = 'flex';
          } else if (tabName === 'history') {
            tab.style.display = 'flex';
            tab.textContent = '–ò—Å—Ç–æ—Ä–∏—è';
          } else if (tabName === 'registration') {
            tab.style.display = 'flex';
            tab.textContent = '–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏';
          } else {
            tab.style.display = 'none';
          }
        } else {
          // Manager can see everything
          if (tabName === 'settings') {
            tab.style.display = 'flex';
          } else {
            tab.style.display = 'flex';
          }
          // Reset tab names for manager
          if (tabName === 'registration') {
            tab.textContent = '–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è';
          } else if (tabName === 'history') {
            tab.textContent = '–ò—Å—Ç–æ—Ä–∏—è';
          }
        }
      });
    }
    
    function hasPermission(permission) {
      if (!currentUserRole) return false;
      return PERMISSIONS[currentUserRole][permission];
    }
    
    // Initialize app
    function initApp() {
      // Only initialize once
      if (drivers.length === 0 && permanentDrivers.length === 0) {
        // Initialize data
        initializePermanentDrivers();
        initializeSampleData();
      }
      
      // Initial render
      renderAll();
      updateCurrentTime();
      updatePermanentDriverSelect();
      renderPermanentDrivers();
      renderFrequentDrivers();

      // Set up form submissions (only once)
      const regForm = document.getElementById('registrationForm');
      if (regForm && !regForm.dataset.initialized) {
        regForm.addEventListener('submit', registerArrival);
        regForm.dataset.initialized = 'true';
      }
      
      const permForm = document.getElementById('permanentDriverForm');
      if (permForm && !permForm.dataset.initialized) {
        permForm.addEventListener('submit', registerPermanentDriverArrival);
        permForm.dataset.initialized = 'true';
      }
      
      const addPermForm = document.getElementById('addPermanentDriverForm');
      if (addPermForm && !addPermForm.dataset.initialized) {
        addPermForm.addEventListener('submit', addPermanentDriver);
        addPermForm.dataset.initialized = 'true';
      }

      // Set up tab navigation (only once)
      document.querySelectorAll('.tab-btn').forEach(btn => {
        if (!btn.dataset.initialized) {
          btn.addEventListener('click', () => switchTab(btn.dataset.tab));
          btn.dataset.initialized = 'true';
        }
      });

      // Set up mode toggle (only once)
      document.querySelectorAll('.mode-btn').forEach(btn => {
        if (!btn.dataset.initialized) {
          btn.addEventListener('click', () => switchMode(btn.dataset.mode));
          btn.dataset.initialized = 'true';
        }
      });
      
      // Update settings if manager
      if (currentUserRole === 'manager') {
        updateSettingsDisplay();
      }

      // Update current time every second (only once)
      if (!window.timeInterval) {
        window.timeInterval = setInterval(updateCurrentTime, 1000);
      }

      // Update durations every 10 seconds (only once)
      if (!updateInterval) {
        updateInterval = setInterval(() => {
          updateDurations();
          updateStatistics();
        }, 10000);
      }
    }

    // Apply role restrictions to UI
    function applyRoleRestrictions() {
      if (currentUserRole === 'driver') {
        // Driver: hide permanent driver mode
        const permanentModeBtn = document.querySelector('.mode-btn[data-mode="permanent"]');
        if (permanentModeBtn) permanentModeBtn.style.display = 'none';
        
        // Hide checkbox for saving as permanent
        const saveAsPermanentCheckbox = document.querySelector('.checkbox-group');
        if (saveAsPermanentCheckbox) saveAsPermanentCheckbox.style.display = 'none';
        
        // Update registration section title
        const regSection = document.querySelector('#registration-tab .registration-section');
        if (regSection) {
          const heading = regSection.querySelector('h2');
          if (heading) heading.textContent = '–ú–æ–π —Å—Ç–∞—Ç—É—Å';
        }
      } else if (currentUserRole === 'supervisor') {
        // Supervisor: read-only, hide all forms and action buttons
        const regTab = document.getElementById('registration-tab');
        if (regTab) {
          const regSection = regTab.querySelector('.registration-section');
          if (regSection) regSection.style.display = 'none';
          
          // Update section title to indicate read-only
          const sectionHeader = regTab.querySelector('.section-header h2');
          if (sectionHeader) sectionHeader.textContent = '–ê–∫—Ç–∏–≤–Ω—ã–µ –≤–æ–¥–∏—Ç–µ–ª–∏';
        }
        
        // Hide all forms
        document.querySelectorAll('form').forEach(form => {
          form.style.display = 'none';
        });
        
        // Hide add permanent driver section
        const permTab = document.getElementById('permanent-tab');
        if (permTab) {
          const regSection = permTab.querySelector('.registration-section');
          if (regSection) regSection.style.display = 'none';
        }
        
        // Buttons will be hidden by the overridden render functions
      } else if (currentUserRole === 'manager') {
        // Manager: full access, show everything
        const permanentModeBtn = document.querySelector('.mode-btn[data-mode="permanent"]');
        if (permanentModeBtn) permanentModeBtn.style.display = 'block';
        
        const saveAsPermanentCheckbox = document.querySelector('.checkbox-group');
        if (saveAsPermanentCheckbox) saveAsPermanentCheckbox.style.display = 'block';
        
        // Update settings display
        if (updateSettingsDisplay) updateSettingsDisplay();
      }
    }
    
    // Manager-only functions
    function exportData() {
      const allData = {
        drivers: drivers,
        permanentDrivers: permanentDrivers,
        exportDate: new Date().toISOString()
      };
      
      const dataStr = JSON.stringify(allData, null, 2);
      const dataBlob = new Blob([dataStr], {type: 'application/json'});
      const url = URL.createObjectURL(dataBlob);
      const link = document.createElement('a');
      link.href = url;
      link.download = `driver-data-${new Date().toISOString().split('T')[0]}.json`;
      link.click();
      URL.revokeObjectURL(url);
      
      showSuccessMessage('–î–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω—ã');
    }
    
    function clearDailyData() {
      if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è?')) {
        const today = new Date().toDateString();
        drivers = drivers.filter(d => {
          const driverDate = new Date(d.arrivalTime).toDateString();
          return driverDate !== today;
        });
        renderAll();
        updateSettingsDisplay();
        showSuccessMessage('–î–∞–Ω–Ω—ã–µ –∑–∞ —Å–µ–≥–æ–¥–Ω—è –æ—á–∏—â–µ–Ω—ã');
      }
    }
    
    function updateSettingsDisplay() {
      if (userLoginTime) {
        const loginTime = new Date(userLoginTime);
        document.getElementById('loginTimeDisplay').textContent = loginTime.toLocaleString('ru-RU');
      }
      document.getElementById('totalRecordsCount').textContent = drivers.length;
    }
    
    // Override render functions to apply role restrictions
    const originalRenderActiveDrivers = renderActiveDrivers;
    renderActiveDrivers = function() {
      originalRenderActiveDrivers();
      
      // Apply role-specific restrictions after rendering
      setTimeout(() => {
        if (currentUserRole === 'supervisor') {
          // Hide all action buttons for supervisor
          document.querySelectorAll('#activeDriversList .btn').forEach(btn => {
            btn.style.display = 'none';
          });
        }
      }, 10);
    };
    
    const originalRenderPermanentDrivers = renderPermanentDrivers;
    renderPermanentDrivers = function() {
      originalRenderPermanentDrivers();
      
      // Apply role-specific restrictions after rendering
      setTimeout(() => {
        if (currentUserRole === 'supervisor' || currentUserRole === 'driver') {
          // Hide action buttons for supervisor and driver
          document.querySelectorAll('#permanentDriversList .action-buttons').forEach(btnGroup => {
            btnGroup.style.display = 'none';
          });
        }
      }, 10);
    };
    
    const originalRenderCompletedDrivers = renderCompletedDrivers;
    renderCompletedDrivers = function() {
      originalRenderCompletedDrivers();
      // No additional restrictions needed for history view
    };
    
    // Start app when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', setupAuth);
    } else {
      setupAuth();
    }
    
    function setupAuth() {
      // Set up login screen
      document.querySelectorAll('.role-btn:not(.location-btn)').forEach(btn => {
        btn.addEventListener('click', () => handleRoleSelection(btn.dataset.role));
      });
      
      // Set up location selection
      document.querySelectorAll('.location-btn').forEach(btn => {
        btn.addEventListener('click', () => handleLocationSelection(btn.dataset.location));
      });
      
      document.getElementById('loginBtn').addEventListener('click', handleLogin);
      document.getElementById('passwordInput').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          handleLogin();
        }
      });
      
      document.getElementById('logoutBtn').addEventListener('click', handleLogout);
      document.getElementById('changeLocationBtn').addEventListener('click', handleChangeLocation);
      
      // Show login screen
      document.getElementById('loginScreen').style.display = 'flex';
    }
  </script>
</body>
</html>